{% extends "base.html" %}
{% block head %}
<style>
    #right-pane{
        width: 27%;
        padding: 10px 1.5%;
    }

    @media (min-width: 992px){
        #content{
            width: 73%;
        }
    }

    @media (min-width: 1336px){
        #right-pane{
            width: calc(0.27 * (100% - 325px));
        }
    }
</style>
{% endblock %}

{%block content%}
    <div class="w-full flex flex-col items-center mt-6">

        <div class="w-full flex flex-col-reverse sm:flex-row items-center p-4 sm:p-8 bg-white mb-7 rounded">
            <div class="three-member-imgs hidden mr-4 sm:flex">
                <img src="" alt="" class="rounded-full p-0.5 bg-white object-cover h-12 w-12">
                <img src="" alt="" class="rounded-full p-0.5 bg-white object-cover h-12 w-12 -ml-5">
                <img src="" alt="" class="rounded-full p-0.5 bg-white object-cover h-12 w-12 -ml-5">
            </div>
            <p class="text-gray-500 flex-shrink-1 mt-2 sm:mt-0">
                <span>{{group.member_count}} Members </span>
                <span class="hidden md:inline">are part of this group</span>
            </p>
            <form id="search-form" class="bg-accent-faded h-13 flex flex-grow self-stretch sm:self-center items-center sm:ml-8 md:ml-16 p-2.5" action="">
                <img src="/static/img/search.svg" alt="" class="mx-1 md:mx-5 h-7 w-7">
                <input type="text" name="" id="member-search-input" placeholder="Search Members..." class="flex-1 bg-transparent min-w-0">
            </form>
        </div>

        <div class="w-5/6 rounded bg-white px-8 py-6 mb-5" >
            <p> Alumni </p>
            <div class="w-full members-section" id="members-alumni">
                
            </div>
        </div>

        <div class="w-5/6 rounded bg-white px-8 py-6 mb-5" >
            <p> Members with common groups</p>
            <div class="w-full members-section" id="members-common">
                
            </div>
        </div>

        <div class="w-5/6 rounded bg-white px-8 py-6 mb-5" >
            <p> Members </p>
            <div class="w-full members-section" id="members-other">
                
            </div>
        </div>

        <div class="w-5/6 rounded bg-white px-8 py-6 mb-5 hidden" >
            <p> Results </p>
            <div class="w-full" id="members-results">   

            </div>
        </div>

    </div>

    <template id="member-entry-temp">
        <div class="flex justify-between items-center py-5">
            <div class="flex items-center justify-start">
                <div class="rounded-full h-14 w-14 overflow-hidden flex items-center justify-center flex-shrink-0">
                    <img src="{{user.account.profile_img_url}}" class= "member-img h-14 w-14 object-cover" alt="">
                </div>
                <div class="mx-4">
                    <p class="member-name mt-1 text-lg font-medium">{{user.account.name}}</p>
                    <p class="member-desg text-xs">Associate Project Manager | Google</p>
                </div>
            </div>
            <div>
                <button class="member-follow bg-accent py-1 px-4 text-white text-md rounded">Follow<b>&#8314</b></button>
            </div>
        </div>
    </template>
    <script type="text" id="group-id">{{group.id}}</script>
{% endblock %}

{% block right-pane %}
    {% include "user_groups.html" %}
{% endblock %}

{% block scripts %}
    <script src="/static/scripts/groups.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6"></script>
    <script>
        $(document).ready(function(){
            const grp_id = $('#group-id').text();
            let members=[];
            let fuse = false;
            let section_vis={};
            $.ajax({
                type:'POST',
                url: `/groups/get-members/${grp_id}/`,
                dataType: 'json',
                success: (data)=>{
                    console.log(data);
                    let ctr=0;
                    for( type in data ){
                        data[type].forEach(ele => {
                            let temp = document.getElementById("member-entry-temp");
                            let p = temp.content.cloneNode(true);
                            $('.member-name',p).text(ele.name);
                            $('.member-img',p).attr('src',ele.profile_img);
                            if(ele.is_followed){
                                $('.member-follow',p).addClass('hidden');
                            }
                            $(`#members-${type}`).append(p);
                            $(`.three-member-imgs img:eq( ${ctr++} )`).attr('src',ele.profile_img);
                            members.push({...ele, type:type});
                        });
                        if(!data[type].length){
                            $(`#members-${type}`).parent().addClass('hidden');
                            section_vis[`members-${type}`]=false;
                        }else{
                            section_vis[`members-${type}`]=true;
                        }
                    }
                    if(ctr<3){
                        for(let i=3; i>ctr; i--){
                            $(`.three-member-imgs img:eq( ${i-1} )`).addClass('hidden');
                        }
                    }
                    fuse = new Fuse(members, {keys:['name']});
                },
                error: (e,f)=>{
                    console.log(f);
                }
            })
            
            $('#member-search-input').on('input change', function(e){
                if(!fuse)return;
                if(this.value.length>=3){
                    $('.members-section').parent().addClass('hidden');
                    $('#members-results').parent().removeClass('hidden');
                    $('#members-results').html("");
                    const res=fuse.search(this.value);
                    if(res.length === 0){
                        $('#members-results').html('<p class="text-lg text-gray-500 text-center">No Results</p>');
                    }
                    res.forEach((ele)=>{
                        let temp = document.getElementById("member-entry-temp");
                        let p = temp.content.cloneNode(true);
                        $('.member-name',p).text(ele.item.name);
                        $('.member-img',p).attr('src',ele.item.profile_img);
                        if(ele.item.is_followed){
                            $('.member-follow',p).addClass('hidden');
                        }
                        $('#members-results').append(p);
                    })
                }else{
                    $('.members-section').each((ind,ele)=>{
                        if(section_vis[ele.id]){
                            $(ele).parent().removeClass('hidden');
                        }
                        $('#members-results').parent().addClass('hidden');
                    })
                }
            })
        })
    </script>
{% endblock %}